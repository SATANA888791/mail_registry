{% extends 'base.html' %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å{% endblock %}

{% block content %}
<h2 class="mb-4">üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>

<div class="row mb-4">
  <!-- –ë–ª–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-123"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–µ–π –ø–∏—Å–µ–º
      </div>
      <div class="card-body">
        <div class="row">
          <!-- –ò—Å—Ö–æ–¥—è—â–∏–µ -->
          <div class="col-md-6 border-end">
            <h5 class="text-center">
              <i class="bi bi-send"></i> –ò—Å—Ö–æ–¥—è—â–∏–µ
            </h5>
            <div class="text-center my-3">
              <span class="fs-4 fw-bold">{{ next_outgoing }}</span>
              <div class="text-muted small">–°–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä</div>
            </div>
            
            <div class="d-flex flex-column gap-2">
              <form action="{{ url_for('admin.reset_outgoing') }}" method="post" 
                    class="confirm-form" data-message="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é –∏—Å—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º?">
                <button type="submit" class="btn btn-warning btn-sm w-100">
                  <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é
                </button>
              </form>
              
              <form action="{{ url_for('admin.release_outgoing') }}" method="post"
                    class="confirm-form" data-message="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –∏—Å—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º?">
                <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                  <i class="bi bi-arrow-left"></i> –û—Å–≤–æ–±–æ–¥–∏—Ç—å –Ω–æ–º–µ—Ä
                </button>
              </form>
            </div>
          </div>
          
          <!-- –í—Ö–æ–¥—è—â–∏–µ -->
          <div class="col-md-6">
            <h5 class="text-center">
              <i class="bi bi-envelope"></i> –í—Ö–æ–¥—è—â–∏–µ
            </h5>
            <div class="text-center my-3">
              <span class="fs-4 fw-bold">{{ next_incoming }}</span>
              <div class="text-muted small">–°–ª–µ–¥—É—é—â–∏–π –Ω–æ–º–µ—Ä</div>
            </div>
            
            <div class="d-flex flex-column gap-2">
              <form action="{{ url_for('admin.reset_incoming') }}" method="post"
                    class="confirm-form" data-message="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º?">
                <button type="submit" class="btn btn-warning btn-sm w-100">
                  <i class="bi bi-arrow-counterclockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é
                </button>
              </form>
              
              <form action="{{ url_for('admin.release_incoming') }}" method="post"
                    class="confirm-form" data-message="–û—Å–≤–æ–±–æ–¥–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–æ–º–µ—Ä –≤—Ö–æ–¥—è—â–∏—Ö –ø–∏—Å–µ–º?">
                <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                  <i class="bi bi-arrow-left"></i> –û—Å–≤–æ–±–æ–¥–∏—Ç—å –Ω–æ–º–µ—Ä
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
  <div class="col-md-6">
    <div class="row">
      <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body text-center">
            <h5 class="card-title"><i class="bi bi-people"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h5>
            <p class="card-text fs-4">{{ total_users }}</p>
            <a href="{{ url_for('admin.user_list') }}" class="btn btn-sm btn-outline-primary">
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            </a>
          </div>
        </div>
      </div>

      <!-- –ü–∏—Å—å–º–∞ -->
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body text-center">
            <h5 class="card-title"><i class="bi bi-mailbox2"></i> –í—Å–µ–≥–æ –ø–∏—Å–µ–º</h5>
            <p class="card-text fs-4">{{ total_mails }}</p>
            <div>
              <a href="{{ url_for('admin.all_outgoing') }}" class="btn btn-sm btn-outline-primary me-1">
                –ò—Å—Ö–æ–¥—è—â–∏–µ
              </a>
              <a href="#" class="btn btn-sm btn-outline-secondary">
                –í—Ö–æ–¥—è—â–∏–µ
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body text-center">
            <h5 class="card-title"><i class="bi bi-slash-circle"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</h5>
            <p class="card-text fs-4">{{ blocked_users }}</p>
            <a href="{{ url_for('admin.user_list') }}?only=blocked" class="btn btn-sm btn-outline-danger">
              –°–ø–∏—Å–æ–∫
            </a>
          </div>
        </div>
      </div>

      <!-- –û–Ω–ª–∞–π–Ω -->
      <div class="col-md-6">
        <div class="card h-100">
          <div class="card-body text-center">
            <h5 class="card-title"><i class="bi bi-lightning-charge"></i> –û–Ω–ª–∞–π–Ω</h5>
            <p class="card-text fs-4">{{ online_users }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="mb-4">
  <a href="{{ url_for('admin.user_create') }}" class="btn btn-success me-2">
    <i class="bi bi-person-plus"></i> –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
  </a>
</div>

<!-- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å -->
<div class="card">
  <div class="card-header">
    <i class="bi bi-clock-history"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
  </div>
  <div class="card-body p-0">
    {% if recent_activity %}
    <div class="list-group list-group-flush">
      {% for log in recent_activity %}
      <div class="list-group-item">
        <div class="d-flex justify-content-between">
          <span class="text-muted small">{{ log.timestamp.strftime('%H:%M %d.%m.%Y') }}</span>
          <span class="badge bg-secondary">{{ log.admin.username if log.admin else '–°–∏—Å—Ç–µ–º–∞' }}</span>
        </div>
        <div class="mt-1">
          {% if log.action == 'unblock' %}
            <i class="bi bi-unlock text-success"></i> –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω {{ log.user.username }}
          {% else %}
            <i class="bi bi-lock text-danger"></i> –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω {{ log.user.username }} 
            {% if log.is_permanent %}
              (–Ω–∞–≤—Å–µ–≥–¥–∞)
            {% else %}
              (–¥–æ {{ log.blocked_until.strftime('%d.%m.%Y %H:%M') }})
            {% endif %}
          {% endif %}
          {% if log.reason %}
            <div class="text-muted small mt-1">–ü—Ä–∏—á–∏–Ω–∞: {{ log.reason }}</div>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center p-4 text-muted">
      –ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    </div>
    {% endif %}
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmMessage">
        –í—ã —É–≤–µ—Ä–µ–Ω—ã?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="confirmButton">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π
  const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
  const confirmMessage = document.getElementById('confirmMessage');
  const confirmButton = document.getElementById('confirmButton');
  
  document.querySelectorAll('.confirm-form').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      confirmMessage.textContent = this.dataset.message;
      confirmButton.onclick = () => form.submit();
      confirmModal.show();
    });
  });
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
  setInterval(() => {
    fetch(window.location.href)
      .then(response => response.text())
      .then(html => {
        const parser = new DOMParser();
        const newDoc = parser.parseFromString(html, 'text/html');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ —Å —Ü–∏—Ñ—Ä–∞–º–∏
        document.querySelectorAll('.card-text.fs-4').forEach((el, index) => {
          const newEl = newDoc.querySelectorAll('.card-text.fs-4')[index];
          if (newEl && el.textContent !== newEl.textContent) {
            el.textContent = newEl.textContent;
          }
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –ø–∏—Å–µ–º
        const newOutgoing = newDoc.querySelector('.col-md-6.border-end .fs-4');
        const newIncoming = newDoc.querySelector('.col-md-6:not(.border-end) .fs-4');
        
        if (newOutgoing) {
          const current = document.querySelector('.col-md-6.border-end .fs-4');
          if (current.textContent !== newOutgoing.textContent) {
            current.textContent = newOutgoing.textContent;
          }
        }
        
        if (newIncoming) {
          const current = document.querySelector('.col-md-6:not(.border-end) .fs-4');
          if (current.textContent !== newIncoming.textContent) {
            current.textContent = newIncoming.textContent;
          }
        }
      });
  }, 60000);
});
</script>
{% endblock %}